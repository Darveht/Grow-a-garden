
<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
<title>Garden Simulator - Tienda Realista</title>
<style>
  :root{
    --glass: rgba(18,24,30,.6);
    --accent:#00d0ff;
    --accent2:#00ffa9;
    --wood:#8b5a2b;
  }
  html,body{height:100%;margin:0;background:linear-gradient(180deg,#9ed7ff,#86c27a);font-family:system-ui,Segoe UI,Roboto,Arial;overflow:hidden}
  canvas{display:block; width:100%; height:100%; touch-action:none; -webkit-user-select:none; user-select:none;}
  
  .hud{position:fixed;left:12px;right:12px;top:12px;display:flex;gap:8px;z-index:120;pointer-events:none}
  .chip{pointer-events:auto;background:var(--glass);backdrop-filter:blur(8px);color:#fff;padding:8px 10px;border-radius:12px;border:1px solid rgba(255,255,255,.06);display:flex;align-items:center;gap:8px}
  .val{font-weight:800}
  
  .dock{position:fixed;left:0;right:0;bottom:12px;display:flex;justify-content:center;z-index:130;pointer-events:none}
  .dockInner{pointer-events:auto;background:var(--glass);backdrop-filter:blur(10px);padding:8px;border-radius:14px;display:flex;gap:8px;border:1px solid rgba(255,255,255,.06)}
  .btn{min-width:64px;padding:10px;border-radius:10px;background:linear-gradient(180deg,rgba(255,255,255,.04),rgba(255,255,255,.02));color:#fff;font-weight:800;border:1px solid rgba(255,255,255,.06)}
  
  .joystick{position:fixed;left:12px;bottom:100px;z-index:160;width:140px;height:140px;pointer-events:auto}
  .joyBase{width:100%;height:100%;border-radius:50%;background:radial-gradient(circle at 30% 30%,rgba(255,255,255,.07),transparent);border:1px solid rgba(255,255,255,.06)}
  .joyKnob{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);width:64px;height:64px;border-radius:50%;background:linear-gradient(180deg,rgba(255,255,255,.12),rgba(255,255,255,.03));border:1px solid rgba(255,255,255,.08)}
  .lookPad{position:fixed;right:0;top:0;bottom:0;width:46vw;z-index:100;pointer-events:auto}
  
  .storePanel{position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);width:min(600px,95vw);max-height:80vh;background:var(--glass);color:#fff;padding:16px;border-radius:16px;display:none;z-index:900;overflow-y:auto}
  .storeHeader{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px}
  .seedGrid{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:12px;margin-bottom:16px}
  .seedDisplay{background:rgba(255,255,255,.1);border-radius:12px;padding:12px;text-align:center;border:2px solid rgba(255,255,255,.2);transition:all 0.3s}
  .seedDisplay:hover{border-color:var(--accent);transform:translateY(-2px)}
  .seedIcon{width:60px;height:60px;margin:0 auto 8px;background:linear-gradient(45deg,#4CAF50,#81C784);border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:28px}
  .seedName{font-weight:bold;margin-bottom:4px}
  .seedPrice{color:#ffd54f;font-weight:800;margin-bottom:8px}
  .seedDesc{font-size:12px;opacity:0.8;margin-bottom:8px}
  
  .cartPanel{position:fixed;right:12px;top:50%;transform:translateY(-50%);width:300px;background:var(--glass);color:#fff;padding:16px;border-radius:16px;display:none;z-index:910}
  .cartItem{display:flex;justify-content:space-between;align-items:center;padding:8px;background:rgba(255,255,255,.1);border-radius:8px;margin-bottom:8px}
  .cartTotal{border-top:2px solid rgba(255,255,255,.2);padding-top:12px;margin-top:12px;font-weight:bold}
  
  .deliveryPanel{position:fixed;left:50%;bottom:20px;transform:translateX(-50%);background:rgba(76,175,80,.9);color:#fff;padding:12px 20px;border-radius:12px;display:none;z-index:920}
  .deliveryBar{width:200px;height:8px;background:rgba(255,255,255,.3);border-radius:4px;margin:8px 0}
  .deliveryProgress{height:100%;background:#fff;border-radius:4px;width:0%;transition:width 1s ease}
  
  .toast{position:fixed;left:50%;top:86px;transform:translateX(-50%);background:var(--glass);color:#fff;padding:8px 12px;border-radius:10px;display:none;z-index:920}
  
  .npcDialog{position:fixed;left:50%;bottom:150px;transform:translateX(-50%);background:rgba(255,255,255,.95);color:#333;padding:12px 16px;border-radius:12px;display:none;z-index:930;max-width:300px;text-align:center}
  .npcName{font-weight:bold;color:var(--accent);margin-bottom:4px}
</style>
</head>
<body>
  <div class="hud">
    <div class="chip">üí∞ <span class="val" id="money">50</span></div>
    <div class="chip">üå± <span class="val" id="seeds">5</span></div>
    <div style="margin-left:auto" class="chip" id="farmTag">üè∑Ô∏è <span id="farmName">Mi Granja</span></div>
  </div>

  <div class="dock">
    <div class="dockInner">
      <button class="btn" id="btnJump">Saltar</button>
      <button class="btn" id="btnHarvest">Cosechar</button>
      <button class="btn" id="btnInteract">Interactuar</button>
      <button class="btn" id="btnPlant">Plantar</button>
    </div>
  </div>

  <div class="joystick" id="joystick"><div class="joyBase"></div><div class="joyKnob" id="knob"></div></div>
  <div class="lookPad" id="lookPad"></div>

  <!-- Tienda -->
  <div class="storePanel" id="storePanel">
    <div class="storeHeader">
      <h3>üè™ Garden Mart - Semillas Premium</h3>
      <button class="btn" id="closeStore">Cerrar</button>
    </div>
    <div class="seedGrid" id="seedGrid"></div>
    <div style="display:flex;gap:12px;justify-content:center">
      <button class="btn" id="viewCart">Ver Carrito (<span id="cartCount">0</span>)</button>
      <button class="btn" id="checkout">Pagar</button>
    </div>
  </div>

  <!-- Carrito -->
  <div class="cartPanel" id="cartPanel">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
      <h4>üõí Carrito</h4>
      <button class="btn" id="closeCart">‚úï</button>
    </div>
    <div id="cartItems"></div>
    <div class="cartTotal">
      Total: $<span id="cartTotalAmount">0</span>
    </div>
    <button class="btn" id="proceedCheckout" style="width:100%;margin-top:12px">Proceder al Pago</button>
  </div>

  <!-- Panel de Entrega -->
  <div class="deliveryPanel" id="deliveryPanel">
    <div>üì¶ Preparando tu pedido...</div>
    <div class="deliveryBar"><div class="deliveryProgress" id="deliveryProgress"></div></div>
    <div id="deliveryTime">Tiempo estimado: 60s</div>
  </div>

  <!-- Di√°logo del NPC -->
  <div class="npcDialog" id="npcDialog">
    <div class="npcName">Roberto - Vendedor</div>
    <div id="npcMessage">¬°Bienvenido a Garden Mart! ¬øEn qu√© puedo ayudarte?</div>
  </div>

  <div class="toast" id="toast"></div>

  <script src="https://cdn.jsdelivr.net/npm/three@0.156.0/build/three.min.js"></script>

  <script>
  // ----- ESTADO DEL JUEGO -----
  let state = { 
    money: 50, 
    seeds: 5, 
    farmName: 'Mi Granja', 
    plants: [],
    cart: [],
    deliveries: []
  };

  // Cat√°logo de semillas expandido
  const seedCatalog = [
    {id: 'carrot', name: 'Zanahoria', price: 2, desc: 'Crece r√°pido, perfecta para principiantes', icon: 'ü•ï', color: '#FF6B35', growTime: 8000},
    {id: 'tomato', name: 'Tomate', price: 4, desc: 'Jugoso y nutritivo, gran demanda', icon: 'üçÖ', color: '#FF4444', growTime: 12000},
    {id: 'corn', name: 'Ma√≠z', price: 6, desc: 'Alto rendimiento, cultivo premium', icon: 'üåΩ', color: '#FFD700', growTime: 15000},
    {id: 'lettuce', name: 'Lechuga', price: 3, desc: 'Fresca y crujiente, f√°cil cuidado', icon: 'ü•¨', color: '#4CAF50', growTime: 10000},
    {id: 'potato', name: 'Papa', price: 5, desc: 'Vers√°til y rentable, larga duraci√≥n', icon: 'ü•î', color: '#8D6E63', growTime: 14000},
    {id: 'pepper', name: 'Pimiento', price: 7, desc: 'Picante y colorido, alta ganancia', icon: 'üå∂Ô∏è', color: '#F44336', growTime: 16000}
  ];

  // ----- THREE.JS SETUP -----
  const scene = new THREE.Scene();
  scene.background = new THREE.Color(0x9ed7ff);
  
  const camera = new THREE.PerspectiveCamera(70, innerWidth/innerHeight, 0.1, 600);
  camera.position.set(0, 1.7, 15);
  
  const renderer = new THREE.WebGLRenderer({antialias: true});
  renderer.setPixelRatio(Math.min(devicePixelRatio, 2));
  renderer.setSize(innerWidth, innerHeight);
  renderer.shadowMap.enabled = true;
  renderer.shadowMap.type = THREE.PCFSoftShadowMap;
  document.body.appendChild(renderer.domElement);

  // Iluminaci√≥n mejorada
  const lightHemi = new THREE.HemisphereLight(0xffffff, 0x4444ff, 0.8);
  scene.add(lightHemi);
  
  const dirLight = new THREE.DirectionalLight(0xffffff, 0.8);
  dirLight.position.set(10, 15, 5);
  dirLight.castShadow = true;
  dirLight.shadow.mapSize.width = 2048;
  dirLight.shadow.mapSize.height = 2048;
  scene.add(dirLight);

  // Suelo
  const ground = new THREE.Mesh(
    new THREE.BoxGeometry(200, 0.4, 200), 
    new THREE.MeshStandardMaterial({color: 0x6fbf5f})
  );
  ground.position.y = -0.2;
  ground.receiveShadow = true;
  scene.add(ground);

  // ----- PLOTS -----
  const plots = [];
  const plotGroup = new THREE.Group();
  scene.add(plotGroup);
  
  const plotSize = 2.2;
  const gap = 0.8;
  for(let rz = 0; rz < 3; rz++) {
    for(let cx = 0; cx < 4; cx++) {
      const x = -6 + cx * (plotSize + gap);
      const z = -2 + rz * (plotSize + gap);
      plots.push({x, z});
      
      // Suelo del plot
      const soil = new THREE.Mesh(
        new THREE.BoxGeometry(plotSize, 0.14, plotSize), 
        new THREE.MeshStandardMaterial({color: 0x5a3d2b})
      );
      soil.position.set(x, 0.02, z);
      soil.receiveShadow = true;
      plotGroup.add(soil);
      
      // Marco de madera
      const frameMat = new THREE.MeshStandardMaterial({color: 0x8b5a2b});
      const thickness = 0.16;
      
      const borders = [
        {pos: [x, 0.2, z - plotSize/2 - thickness/2], size: [plotSize + thickness, 0.3, thickness]},
        {pos: [x, 0.2, z + plotSize/2 + thickness/2], size: [plotSize + thickness, 0.3, thickness]},
        {pos: [x - plotSize/2 - thickness/2, 0.2, z], size: [thickness, 0.3, plotSize + thickness]},
        {pos: [x + plotSize/2 + thickness/2, 0.2, z], size: [thickness, 0.3, plotSize + thickness]}
      ];
      
      borders.forEach(border => {
        const frame = new THREE.Mesh(new THREE.BoxGeometry(...border.size), frameMat);
        frame.position.set(...border.pos);
        frame.castShadow = true;
        plotGroup.add(frame);
      });
    }
  }

  // ----- TIENDA REALISTA -----
  const storeGroup = new THREE.Group();
  
  // Edificio principal
  const storeBase = new THREE.Mesh(
    new THREE.BoxGeometry(12, 4, 8), 
    new THREE.MeshStandardMaterial({color: 0xe3f2fd})
  );
  storeBase.position.set(0, 2, -15);
  storeBase.castShadow = true;
  storeGroup.add(storeBase);

  // Techo
  const roof = new THREE.Mesh(
    new THREE.BoxGeometry(13, 0.3, 9), 
    new THREE.MeshStandardMaterial({color: 0x1976d2})
  );
  roof.position.set(0, 4.2, -15);
  storeGroup.add(roof);

  // Letrero
  const sign = new THREE.Mesh(
    new THREE.BoxGeometry(8, 1, 0.2), 
    new THREE.MeshStandardMaterial({color: 0x4CAF50})
  );
  sign.position.set(0, 3.5, -10.9);
  storeGroup.add(sign);

  // Puerta de cristal
  const door = new THREE.Mesh(
    new THREE.BoxGeometry(2, 3, 0.1), 
    new THREE.MeshStandardMaterial({
      color: 0x81c784, 
      transparent: true, 
      opacity: 0.7
    })
  );
  door.position.set(0, 1.5, -10.95);
  storeGroup.add(door);

  // Displays de semillas dentro de la tienda
  const displayGroup = new THREE.Group();
  const displayPositions = [
    {x: -3, z: -13}, {x: 0, z: -13}, {x: 3, z: -13},
    {x: -3, z: -15}, {x: 0, z: -15}, {x: 3, z: -15}
  ];

  displayPositions.forEach((pos, i) => {
    const seed = seedCatalog[i] || seedCatalog[0];
    
    // Base del display
    const base = new THREE.Mesh(
      new THREE.BoxGeometry(1.5, 0.8, 1.5), 
      new THREE.MeshStandardMaterial({color: 0xffffff})
    );
    base.position.set(pos.x, 0.4, pos.z);
    displayGroup.add(base);
    
    // C√∫pula de cristal
    const glass = new THREE.Mesh(
      new THREE.SphereGeometry(0.6, 16, 8, 0, Math.PI * 2, 0, Math.PI * 0.7), 
      new THREE.MeshStandardMaterial({
        color: 0xffffff, 
        transparent: true, 
        opacity: 0.3,
        envMapIntensity: 1
      })
    );
    glass.position.set(pos.x, 1.0, pos.z);
    displayGroup.add(glass);
    
    // Semilla dentro del cristal
    const seedMesh = new THREE.Mesh(
      new THREE.BoxGeometry(0.3, 0.3, 0.3), 
      new THREE.MeshStandardMaterial({color: seed.color})
    );
    seedMesh.position.set(pos.x, 0.9, pos.z);
    seedMesh.userData = {seedId: seed.id, price: seed.price, name: seed.name};
    displayGroup.add(seedMesh);
    
    // Etiqueta de precio
    const label = new THREE.Mesh(
      new THREE.BoxGeometry(0.8, 0.2, 0.05), 
      new THREE.MeshStandardMaterial({color: 0xffd54f})
    );
    label.position.set(pos.x, 0.1, pos.z + 0.8);
    displayGroup.add(label);
  });
  
  storeGroup.add(displayGroup);

  // NPC Vendedor
  const npcGroup = new THREE.Group();
  
  // Cuerpo del NPC
  const npcBody = new THREE.Mesh(
    new THREE.BoxGeometry(0.6, 1.2, 0.4), 
    new THREE.MeshStandardMaterial({color: 0x2196F3})
  );
  npcBody.position.y = 1.2;
  npcGroup.add(npcBody);
  
  // Cabeza
  const npcHead = new THREE.Mesh(
    new THREE.BoxGeometry(0.4, 0.4, 0.4), 
    new THREE.MeshStandardMaterial({color: 0xffdbcb})
  );
  npcHead.position.y = 2.0;
  npcGroup.add(npcHead);
  
  // Brazos
  const armLeft = new THREE.Mesh(
    new THREE.BoxGeometry(0.2, 0.8, 0.2), 
    new THREE.MeshStandardMaterial({color: 0xffdbcb})
  );
  armLeft.position.set(-0.5, 1.2, 0);
  npcGroup.add(armLeft);
  
  const armRight = armLeft.clone();
  armRight.position.set(0.5, 1.2, 0);
  npcGroup.add(armRight);
  
  npcGroup.position.set(1.5, 0, -14);
  storeGroup.add(npcGroup);
  
  scene.add(storeGroup);

  // Caja registradora
  const cashRegister = new THREE.Mesh(
    new THREE.BoxGeometry(1, 0.5, 0.8), 
    new THREE.MeshStandardMaterial({color: 0x424242})
  );
  cashRegister.position.set(-1.5, 1.05, -14);
  storeGroup.add(cashRegister);

  // ----- PLANTAS -----
  const cropsGroup = new THREE.Group();
  scene.add(cropsGroup);

  // ----- MOVIMIENTO CORREGIDO -----
  let yaw = 0, pitch = 0;
  camera.rotation.order = 'YXZ';
  
  function applyCam() {
    camera.rotation.set(pitch, yaw, 0, 'YXZ');
  }

  // Joystick (MOVIMIENTO CORREGIDO)
  let joy = {x: 0, y: 0, active: false};
  let vel = new THREE.Vector3();
  let canJump = true;
  
  const joyEl = document.getElementById('joystick');
  const knob = document.getElementById('knob');
  
  joyEl.addEventListener('touchstart', (e) => {
    joy.active = true;
    e.preventDefault();
  }, {passive: false});
  
  joyEl.addEventListener('touchmove', (e) => {
    e.preventDefault();
    const touch = e.touches[0];
    const rect = joyEl.getBoundingClientRect();
    const centerX = rect.left + rect.width / 2;
    const centerY = rect.top + rect.height / 2;
    
    let dx = touch.clientX - centerX;
    let dy = touch.clientY - centerY;
    
    const maxRadius = rect.width * 0.42;
    const distance = Math.hypot(dx, dy);
    const clamp = distance > maxRadius ? maxRadius / distance : 1;
    
    dx *= clamp;
    dy *= clamp;
    
    knob.style.transform = `translate(${dx}px, ${dy}px)`;
    
    joy.x = dx / maxRadius;
    joy.y = dy / maxRadius; // SIN NEGATIVO - ESTO CORRIGE EL MOVIMIENTO
  }, {passive: false});
  
  joyEl.addEventListener('touchend', () => {
    joy.active = false;
    joy.x = 0;
    joy.y = 0;
    knob.style.transform = 'translate(-50%, -50%)';
  });

  // Look pad
  const lookPad = document.getElementById('lookPad');
  let lastLook = null;
  let lookVelX = 0, lookVelY = 0;
  
  lookPad.addEventListener('touchstart', e => {
    lastLook = e.touches[0];
  }, {passive: true});
  
  lookPad.addEventListener('touchmove', e => {
    const touch = e.touches[0];
    if (!lastLook) {
      lastLook = touch;
      return;
    }
    
    const dx = touch.clientX - lastLook.clientX;
    const dy = touch.clientY - lastLook.clientY;
    lastLook = touch;
    
    const sensitivity = 0.001;
    lookVelX += (-dx * sensitivity);
    lookVelY += (-dy * sensitivity);
  }, {passive: true});
  
  lookPad.addEventListener('touchend', () => {
    lastLook = null;
  });

  // ----- RAYCAST -----
  const raycaster = new THREE.Raycaster();

  // ----- SISTEMA DE TIENDA -----
  const storePanel = document.getElementById('storePanel');
  const cartPanel = document.getElementById('cartPanel');
  const seedGrid = document.getElementById('seedGrid');
  const cartItems = document.getElementById('cartItems');
  const cartCount = document.getElementById('cartCount');
  const cartTotalAmount = document.getElementById('cartTotalAmount');
  const npcDialog = document.getElementById('npcDialog');
  const npcMessage = document.getElementById('npcMessage');

  // Renderizar cat√°logo de semillas
  function renderSeedCatalog() {
    seedGrid.innerHTML = '';
    seedCatalog.forEach(seed => {
      const div = document.createElement('div');
      div.className = 'seedDisplay';
      div.innerHTML = `
        <div class="seedIcon" style="background: linear-gradient(45deg, ${seed.color}, ${seed.color}aa)">${seed.icon}</div>
        <div class="seedName">${seed.name}</div>
        <div class="seedPrice">$${seed.price}</div>
        <div class="seedDesc">${seed.desc}</div>
        <button class="btn addToCart" data-seed-id="${seed.id}">Agregar al Carrito</button>
      `;
      seedGrid.appendChild(div);
    });
  }

  // Agregar al carrito
  seedGrid.addEventListener('click', (e) => {
    if (e.target.classList.contains('addToCart')) {
      const seedId = e.target.dataset.seedId;
      const seed = seedCatalog.find(s => s.id === seedId);
      
      const existing = state.cart.find(item => item.id === seedId);
      if (existing) {
        existing.quantity++;
      } else {
        state.cart.push({...seed, quantity: 1});
      }
      
      updateCartDisplay();
      showToast(`${seed.name} agregado al carrito!`);
    }
  });

  // Actualizar display del carrito
  function updateCartDisplay() {
    cartItems.innerHTML = '';
    let total = 0;
    
    state.cart.forEach(item => {
      const div = document.createElement('div');
      div.className = 'cartItem';
      div.innerHTML = `
        <div>
          <div>${item.icon} ${item.name}</div>
          <div style="font-size:12px">Cantidad: ${item.quantity}</div>
        </div>
        <div>
          <div>$${item.price * item.quantity}</div>
          <button class="btn removeItem" data-seed-id="${item.id}" style="font-size:12px;padding:2px 6px">-</button>
        </div>
      `;
      cartItems.appendChild(div);
      total += item.price * item.quantity;
    });
    
    cartCount.textContent = state.cart.reduce((sum, item) => sum + item.quantity, 0);
    cartTotalAmount.textContent = total;
  }

  // Remover del carrito
  cartItems.addEventListener('click', (e) => {
    if (e.target.classList.contains('removeItem')) {
      const seedId = e.target.dataset.seedId;
      const index = state.cart.findIndex(item => item.id === seedId);
      if (index !== -1) {
        if (state.cart[index].quantity > 1) {
          state.cart[index].quantity--;
        } else {
          state.cart.splice(index, 1);
        }
        updateCartDisplay();
      }
    }
  });

  // Sistema de entrega
  function startDelivery() {
    const deliveryPanel = document.getElementById('deliveryPanel');
    const deliveryProgress = document.getElementById('deliveryProgress');
    const deliveryTime = document.getElementById('deliveryTime');
    
    deliveryPanel.style.display = 'block';
    
    let progress = 0;
    const duration = 60000; // 60 segundos
    const interval = 100;
    const increment = (interval / duration) * 100;
    
    const timer = setInterval(() => {
      progress += increment;
      deliveryProgress.style.width = `${Math.min(progress, 100)}%`;
      
      const remaining = Math.max(0, Math.ceil((100 - progress) * duration / 100 / 1000));
      deliveryTime.textContent = `Tiempo estimado: ${remaining}s`;
      
      if (progress >= 100) {
        clearInterval(timer);
        deliveryComplete();
      }
    }, interval);
  }

  function deliveryComplete() {
    const deliveryPanel = document.getElementById('deliveryPanel');
    deliveryPanel.style.display = 'none';
    
    // Agregar semillas al inventario
    state.cart.forEach(item => {
      state.seeds += item.quantity;
    });
    
    state.cart = [];
    updateCartDisplay();
    updateUI();
    showToast('¬°Pedido entregado! Revisa tu inventario üì¶');
  }

  // Checkout
  function checkout() {
    const total = state.cart.reduce((sum, item) => sum + item.price * item.quantity, 0);
    
    if (state.money < total) {
      showToast('No tienes suficiente dinero üí∞');
      return;
    }
    
    if (state.cart.length === 0) {
      showToast('El carrito est√° vac√≠o üõí');
      return;
    }
    
    state.money -= total;
    storePanel.style.display = 'none';
    cartPanel.style.display = 'none';
    
    showNPCDialog('¬°Gracias por tu compra! Tu pedido llegar√° en 1 minuto üì¶');
    startDelivery();
  }

  // Di√°logo del NPC
  function showNPCDialog(message, duration = 3000) {
    npcMessage.textContent = message;
    npcDialog.style.display = 'block';
    
    setTimeout(() => {
      npcDialog.style.display = 'none';
    }, duration);
  }

  // ----- INTERACCIONES -----
  function tryInteract() {
    const playerPos = camera.position;
    
    // Verificar si est√° cerca de la tienda
    const storeDistance = playerPos.distanceTo(new THREE.Vector3(0, 1.7, -12));
    if (storeDistance < 4) {
      storePanel.style.display = 'block';
      renderSeedCatalog();
      showNPCDialog('¬°Bienvenido a Garden Mart! Tenemos las mejores semillas üå±');
      return;
    }
    
    // Verificar displays individuales
    for (const child of displayGroup.children) {
      if (child.userData.seedId) {
        const distance = playerPos.distanceTo(child.position);
        if (distance < 2) {
          const seed = seedCatalog.find(s => s.id === child.userData.seedId);
          showNPCDialog(`${seed.icon} ${seed.name} - $${seed.price}\n${seed.desc}`, 2000);
          return;
        }
      }
    }
    
    showToast('Nada para interactuar cerca');
  }

  // Plantar
  function tryPlant() {
    if (state.seeds <= 0) {
      showToast('No tienes semillas üå±');
      return;
    }
    
    // Raycast al suelo
    raycaster.setFromCamera({x: 0, y: 0}, camera);
    const intersects = raycaster.intersectObject(ground);
    
    if (intersects.length > 0) {
      const point = intersects[0].point;
      
      // Encontrar plot m√°s cercano
      let closestPlot = null;
      let minDistance = Infinity;
      
      plots.forEach((plot, index) => {
        const distance = Math.hypot(point.x - plot.x, point.z - plot.z);
        if (distance < plotSize / 2 && distance < minDistance) {
          minDistance = distance;
          closestPlot = {index, ...plot};
        }
      });
      
      if (closestPlot) {
        // Verificar si ya hay una planta
        const existing = state.plants.find(p => p.plotIndex === closestPlot.index);
        if (existing) {
          showToast('Ya hay una planta aqu√≠ üå±');
          return;
        }
        
        // Plantar
        state.seeds--;
        state.plants.push({
          plotIndex: closestPlot.index,
          plantedAt: Date.now(),
          type: 'basic'
        });
        
        rebuildPlants();
        updateUI();
        showToast('¬°Semilla plantada! üå±');
      } else {
        showToast('Debes estar cerca de un plot para plantar');
      }
    }
  }

  // Cosechar
  function tryHarvest() {
    raycaster.setFromCamera({x: 0, y: 0}, camera);
    const intersects = raycaster.intersectObjects(cropsGroup.children, true);
    
    if (intersects.length > 0) {
      const plant = intersects[0].object;
      const data = plant.userData;
      
      if (data && data.plotIndex !== undefined) {
        const plantIndex = state.plants.findIndex(p => p.plotIndex === data.plotIndex);
        if (plantIndex !== -1) {
          const plantData = state.plants[plantIndex];
          const age = Date.now() - plantData.plantedAt;
          const growTime = 12000; // 12 segundos
          
          if (age >= growTime) {
            state.plants.splice(plantIndex, 1);
            state.money += 5;
            if (Math.random() < 0.3) state.seeds++;
            
            rebuildPlants();
            updateUI();
            showToast('¬°Cosechado! +$5 üí∞');
          } else {
            showToast('La planta a√∫n est√° creciendo üå±');
          }
        }
      }
    } else {
      showToast('Apunta a una planta madura para cosechar');
    }
  }

  // Reconstruir plantas
  function rebuildPlants() {
    // Limpiar plantas existentes
    while (cropsGroup.children.length) {
      cropsGroup.remove(cropsGroup.children[0]);
    }
    
    const now = Date.now();
    
    state.plants.forEach(plant => {
      const plot = plots[plant.plotIndex];
      if (!plot) return;
      
      const age = now - plant.plantedAt;
      const growTime = 12000; // 12 segundos
      const growthStage = Math.min(age / growTime, 1);
      
      const size = 0.3 + growthStage * 0.7;
      const color = growthStage >= 1 ? 0xffd54f : 0x4CAF50;
      
      const plantMesh = new THREE.Mesh(
        new THREE.BoxGeometry(0.4 * size, 0.8 * size, 0.4 * size),
        new THREE.MeshStandardMaterial({color})
      );
      
      plantMesh.position.set(plot.x, 0.2 + (0.4 * size), plot.z);
      plantMesh.castShadow = true;
      plantMesh.userData = {plotIndex: plant.plotIndex, plantedAt: plant.plantedAt};
      
      cropsGroup.add(plantMesh);
    });
  }

  // Actualizar UI
  function updateUI() {
    document.getElementById('money').textContent = state.money;
    document.getElementById('seeds').textContent = state.seeds;
    document.getElementById('farmName').textContent = state.farmName;
  }

  // Toast
  function showToast(message, duration = 2000) {
    const toast = document.getElementById('toast');
    toast.textContent = message;
    toast.style.display = 'block';
    
    setTimeout(() => {
      toast.style.display = 'none';
    }, duration);
  }

  // ----- EVENT LISTENERS -----
  document.getElementById('btnInteract').addEventListener('click', tryInteract);
  document.getElementById('btnPlant').addEventListener('click', tryPlant);
  document.getElementById('btnHarvest').addEventListener('click', tryHarvest);
  document.getElementById('btnJump').addEventListener('click', () => {
    if (canJump) {
      vel.y = 8;
      canJump = false;
    }
  });

  // Tienda
  document.getElementById('closeStore').addEventListener('click', () => {
    storePanel.style.display = 'none';
  });

  document.getElementById('viewCart').addEventListener('click', () => {
    cartPanel.style.display = cartPanel.style.display === 'block' ? 'none' : 'block';
  });

  document.getElementById('closeCart').addEventListener('click', () => {
    cartPanel.style.display = 'none';
  });

  document.getElementById('checkout').addEventListener('click', checkout);
  document.getElementById('proceedCheckout').addEventListener('click', checkout);

  // ----- GAME LOOP -----
  let lastTime = performance.now();
  
  function gameLoop() {
    requestAnimationFrame(gameLoop);
    
    const currentTime = performance.now();
    const deltaTime = Math.min((currentTime - lastTime) / 1000, 0.05);
    lastTime = currentTime;
    
    // Aplicar velocidades de look con damping
    lookVelX *= 0.9;
    lookVelY *= 0.9;
    
    yaw += lookVelX;
    pitch += lookVelY;
    
    // Limitar pitch
    const maxPitch = Math.PI / 2 - 0.1;
    pitch = Math.max(-maxPitch, Math.min(maxPitch, pitch));
    
    applyCam();
    
    // Movimiento (CORREGIDO)
    if (joy.active) {
      const speed = 8;
      
      // Calcular direcciones basadas en la rotaci√≥n de la c√°mara
      const forward = new THREE.Vector3(
        Math.sin(yaw), 
        0, 
        Math.cos(yaw) // CAMBIADO: era -Math.cos(yaw)
      ).normalize();
      
      const right = new THREE.Vector3().crossVectors(
        new THREE.Vector3(0, 1, 0), 
        forward
      ).normalize();
      
      // Aplicar movimiento
      const moveForward = -joy.y; // NEGATIVO porque joy.y positivo es hacia abajo
      const moveRight = joy.x;
      
      vel.x += (forward.x * moveForward + right.x * moveRight) * speed * deltaTime;
      vel.z += (forward.z * moveForward + right.z * moveRight) * speed * deltaTime;
    }
    
    // Fricci√≥n y gravedad
    vel.x *= 0.9;
    vel.z *= 0.9;
    vel.y -= 25 * deltaTime;
    
    // Aplicar velocidad
    camera.position.x += vel.x * deltaTime;
    camera.position.y += vel.y * deltaTime;
    camera.position.z += vel.z * deltaTime;
    
    // Colisi√≥n con suelo
    if (camera.position.y < 1.7) {
      camera.position.y = 1.7;
      vel.y = 0;
      canJump = true;
    }
    
    // Animar plantas
    cropsGroup.children.forEach(plant => {
      plant.rotation.y += 0.01;
    });
    
    // Animar NPC
    if (npcGroup) {
      npcGroup.rotation.y = Math.sin(currentTime * 0.001) * 0.1;
    }
    
    renderer.render(scene, camera);
  }

  // ----- INICIALIZACI√ìN -----
  updateUI();
  updateCartDisplay();
  rebuildPlants();
  gameLoop();

  // Resize handler
  window.addEventListener('resize', () => {
    camera.aspect = window.innerWidth / window.innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(window.innerWidth, window.innerHeight);
  });

  </script>
</body>
</html>
