
<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
<title>Garden Simulator - Tienda Realista</title>
<style>
  :root{
    --glass: rgba(18,24,30,.6);
    --accent:#00d0ff;
    --accent2:#00ffa9;
    --wood:#8b5a2b;
    --primary: #4CAF50;
    --secondary: #FF6B35;
  }
  html,body{height:100%;margin:0;background:linear-gradient(180deg,#9ed7ff,#86c27a);font-family:system-ui,Segoe UI,Roboto,Arial;overflow:hidden}
  canvas{display:block; width:100%; height:100%; touch-action:none; -webkit-user-select:none; user-select:none;}
  
  /* ===== PANTALLA DE INICIO ===== */
  .startScreen{
    position:fixed;
    top:0;
    left:0;
    width:100vw;
    height:100vh;
    background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    display:flex;
    flex-direction:column;
    align-items:center;
    justify-content:center;
    z-index:1000;
    color:white;
  }
  
  .gameTitle{
    font-size:clamp(2rem, 8vw, 4rem);
    font-weight:900;
    text-align:center;
    margin-bottom:1rem;
    background:linear-gradient(45deg, #00d0ff, #00ffa9);
    -webkit-background-clip:text;
    -webkit-text-fill-color:transparent;
    background-clip:text;
    text-shadow:0 0 30px rgba(0,208,255,0.5);
  }
  
  .gameSubtitle{
    font-size:1.2rem;
    opacity:0.9;
    margin-bottom:3rem;
    text-align:center;
  }
  
  .mainMenu{
    display:flex;
    flex-direction:column;
    gap:1rem;
    min-width:300px;
  }
  
  .menuBtn{
    padding:15px 30px;
    background:var(--glass);
    backdrop-filter:blur(10px);
    border:2px solid rgba(255,255,255,0.2);
    border-radius:15px;
    color:white;
    font-size:1.1rem;
    font-weight:600;
    cursor:pointer;
    transition:all 0.3s ease;
    text-align:center;
  }
  
  .menuBtn:hover{
    background:rgba(255,255,255,0.1);
    border-color:var(--accent);
    transform:translateY(-2px);
    box-shadow:0 10px 25px rgba(0,208,255,0.3);
  }
  
  .menuBtn.primary{
    background:linear-gradient(135deg, var(--primary), #45a049);
    border-color:var(--primary);
  }
  
  .menuBtn.secondary{
    background:linear-gradient(135deg, var(--secondary), #e55a2b);
    border-color:var(--secondary);
  }
  
  /* ===== PANEL DE CONFIGURACIONES ===== */
  .settingsPanel{
    position:fixed;
    top:50%;
    left:50%;
    transform:translate(-50%, -50%);
    width:min(500px, 90vw);
    max-height:80vh;
    background:var(--glass);
    backdrop-filter:blur(15px);
    border:2px solid rgba(255,255,255,0.2);
    border-radius:20px;
    padding:2rem;
    color:white;
    display:none;
    z-index:1100;
    overflow-y:auto;
  }
  
  .settingsHeader{
    display:flex;
    justify-content:space-between;
    align-items:center;
    margin-bottom:2rem;
    border-bottom:2px solid rgba(255,255,255,0.1);
    padding-bottom:1rem;
  }
  
  .settingsHeader h3{
    margin:0;
    font-size:1.5rem;
    color:var(--accent);
  }
  
  .closeBtn{
    background:none;
    border:none;
    color:white;
    font-size:1.5rem;
    cursor:pointer;
    padding:5px;
    border-radius:50%;
    width:35px;
    height:35px;
    display:flex;
    align-items:center;
    justify-content:center;
  }
  
  .closeBtn:hover{
    background:rgba(255,255,255,0.1);
  }
  
  .settingGroup{
    margin-bottom:1.5rem;
  }
  
  .settingLabel{
    display:block;
    margin-bottom:0.5rem;
    font-weight:600;
    color:var(--accent2);
  }
  
  .settingControl{
    width:100%;
    padding:10px;
    background:rgba(255,255,255,0.1);
    border:1px solid rgba(255,255,255,0.2);
    border-radius:8px;
    color:white;
    font-size:1rem;
  }
  
  .settingControl:focus{
    outline:none;
    border-color:var(--accent);
    box-shadow:0 0 10px rgba(0,208,255,0.3);
  }
  
  .slider{
    -webkit-appearance:none;
    appearance:none;
    height:6px;
    background:rgba(255,255,255,0.2);
    border-radius:3px;
    outline:none;
  }
  
  .slider::-webkit-slider-thumb{
    -webkit-appearance:none;
    appearance:none;
    width:20px;
    height:20px;
    background:var(--accent);
    border-radius:50%;
    cursor:pointer;
  }
  
  .checkbox{
    width:auto;
    margin-right:10px;
  }
  
  /* ===== PANEL ONLINE ===== */
  .onlinePanel{
    position:fixed;
    top:50%;
    left:50%;
    transform:translate(-50%, -50%);
    width:min(600px, 90vw);
    max-height:80vh;
    background:var(--glass);
    backdrop-filter:blur(15px);
    border:2px solid rgba(255,255,255,0.2);
    border-radius:20px;
    padding:2rem;
    color:white;
    display:none;
    z-index:1100;
    overflow-y:auto;
  }
  
  .onlineOptions{
    display:grid;
    grid-template-columns:repeat(auto-fit, minmax(250px, 1fr));
    gap:1rem;
    margin-top:1rem;
  }
  
  .onlineCard{
    background:rgba(255,255,255,0.1);
    border:2px solid rgba(255,255,255,0.2);
    border-radius:15px;
    padding:1.5rem;
    text-align:center;
    cursor:pointer;
    transition:all 0.3s ease;
  }
  
  .onlineCard:hover{
    border-color:var(--accent);
    transform:translateY(-5px);
    box-shadow:0 15px 30px rgba(0,208,255,0.2);
  }
  
  .onlineCard h4{
    margin:0 0 1rem 0;
    color:var(--accent2);
    font-size:1.3rem;
  }
  
  .onlineCard p{
    opacity:0.8;
    font-size:0.9rem;
    line-height:1.4;
  }
  
  .roomInput{
    display:flex;
    gap:10px;
    margin-top:1rem;
  }
  
  .roomInput input{
    flex:1;
    padding:10px;
    background:rgba(255,255,255,0.1);
    border:1px solid rgba(255,255,255,0.2);
    border-radius:8px;
    color:white;
  }
  
  /* ===== ANIMACIONES ===== */
  @keyframes fadeIn{
    from{opacity:0;transform:translateY(20px)}
    to{opacity:1;transform:translateY(0)}
  }
  
  @keyframes slideIn{
    from{transform:translate(-50%, -60%);opacity:0}
    to{transform:translate(-50%, -50%);opacity:1}
  }
  
  .fadeIn{animation:fadeIn 0.6s ease-out}
  .slideIn{animation:slideIn 0.4s ease-out}
  
  /* ===== ESTILOS DEL JUEGO (cuando est√° activo) ===== */
  .gameScreen{display:none}
  .gameScreen.active{display:block}
  
  .hud{position:fixed;left:12px;right:12px;top:12px;display:flex;gap:8px;z-index:120;pointer-events:none}
  .chip{pointer-events:auto;background:var(--glass);backdrop-filter:blur(8px);color:#fff;padding:8px 10px;border-radius:12px;border:1px solid rgba(255,255,255,.06);display:flex;align-items:center;gap:8px}
  .val{font-weight:800}
  
  .dock{position:fixed;left:0;right:0;bottom:12px;display:flex;justify-content:center;z-index:130;pointer-events:none}
  .dockInner{pointer-events:auto;background:var(--glass);backdrop-filter:blur(10px);padding:8px;border-radius:14px;display:flex;gap:8px;border:1px solid rgba(255,255,255,.06)}
  .btn{min-width:64px;padding:10px;border-radius:10px;background:linear-gradient(180deg,rgba(255,255,255,.04),rgba(255,255,255,.02));color:#fff;font-weight:800;border:1px solid rgba(255,255,255,.06)}
  
  .joystick{position:fixed;left:12px;bottom:100px;z-index:160;width:140px;height:140px;pointer-events:auto}
  .joyBase{width:100%;height:100%;border-radius:50%;background:radial-gradient(circle at 30% 30%,rgba(255,255,255,.07),transparent);border:1px solid rgba(255,255,255,.06)}
  .joyKnob{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);width:64px;height:64px;border-radius:50%;background:linear-gradient(180deg,rgba(255,255,255,.12),rgba(255,255,255,.03));border:1px solid rgba(255,255,255,.08)}
  .lookPad{position:fixed;right:0;top:0;bottom:0;width:46vw;z-index:100;pointer-events:auto}
  
  .inventoryPanel{position:fixed;right:12px;top:80px;width:200px;background:var(--glass);color:#fff;padding:12px;border-radius:12px;z-index:140;backdrop-filter:blur(8px);border:1px solid rgba(255,255,255,.06)}
  .inventoryTitle{font-weight:bold;margin-bottom:8px;text-align:center;color:var(--accent)}
  .inventoryGrid{display:grid;grid-template-columns:repeat(3,1fr);gap:4px}
  .inventorySlot{aspect-ratio:1;background:rgba(255,255,255,.1);border-radius:6px;display:flex;flex-direction:column;align-items:center;justify-content:center;font-size:16px;border:1px solid rgba(255,255,255,.2)}
  .inventorySlot.has-item{background:rgba(76,175,80,.3);border-color:var(--accent2)}
  .slotCount{font-size:10px;font-weight:bold}
  
  .storePanel{position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);width:min(600px,95vw);max-height:80vh;background:var(--glass);color:#fff;padding:16px;border-radius:16px;display:none;z-index:900;overflow-y:auto}
  .storeHeader{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px}
  .seedGrid{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:12px;margin-bottom:16px}
  .seedDisplay{background:rgba(255,255,255,.1);border-radius:12px;padding:12px;text-align:center;border:2px solid rgba(255,255,255,.2);transition:all 0.3s}
  .seedDisplay:hover{border-color:var(--accent);transform:translateY(-2px)}
  .seedIcon{width:60px;height:60px;margin:0 auto 8px;background:linear-gradient(45deg,#4CAF50,#81C784);border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:28px}
  .seedName{font-weight:bold;margin-bottom:4px}
  .seedPrice{color:#ffd54f;font-weight:800;margin-bottom:8px}
  .seedDesc{font-size:12px;opacity:0.8;margin-bottom:8px}
  
  .cartPanel{position:fixed;right:12px;top:50%;transform:translateY(-50%);width:300px;background:var(--glass);color:#fff;padding:16px;border-radius:16px;display:none;z-index:910}
  .cartItem{display:flex;justify-content:space-between;align-items:center;padding:8px;background:rgba(255,255,255,.1);border-radius:8px;margin-bottom:8px}
  .cartTotal{border-top:2px solid rgba(255,255,255,.2);padding-top:12px;margin-top:12px;font-weight:bold}
  
  .deliveryBox{position:fixed;left:50%;bottom:20px;transform:translateX(-50%);background:rgba(139,69,19,.9);color:#fff;padding:16px;border-radius:12px;display:none;z-index:920;text-align:center;cursor:pointer;border:3px solid #ffd54f}
  .deliveryBox:hover{background:rgba(139,69,19,1);transform:translateX(-50%) scale(1.05)}
  .ticketInfo{background:rgba(255,255,255,.1);padding:8px;border-radius:8px;margin:8px 0;font-size:12px}
  
  .toast{position:fixed;left:50%;top:86px;transform:translateX(-50%);background:var(--glass);color:#fff;padding:8px 12px;border-radius:10px;display:none;z-index:920}
  
  .npcDialog{position:fixed;left:50%;bottom:150px;transform:translateX(-50%);background:rgba(255,255,255,.95);color:#333;padding:12px 16px;border-radius:12px;display:none;z-index:930;max-width:300px;text-align:center}
  .npcName{font-weight:bold;color:var(--accent);margin-bottom:4px}
  
  .touchIndicator{position:absolute;pointer-events:none;width:30px;height:30px;border:3px solid var(--accent);border-radius:50%;animation:touchPulse 0.5s ease-out}
  @keyframes touchPulse{from{transform:scale(0);opacity:1}to{transform:scale(1);opacity:0}}
  
  .backBtn{
    position:absolute;
    top:20px;
    left:20px;
    background:var(--glass);
    backdrop-filter:blur(10px);
    border:2px solid rgba(255,255,255,0.2);
    border-radius:10px;
    color:white;
    padding:10px 15px;
    cursor:pointer;
    font-weight:600;
  }
  
  .backBtn:hover{
    background:rgba(255,255,255,0.1);
    border-color:var(--accent);
  }
</style>
</head>
<body>
  <!-- ===== PANTALLA DE INICIO ===== -->
  <div class="startScreen" id="startScreen">
    <div class="fadeIn">
      <h1 class="gameTitle">üå± Garden Simulator</h1>
      <p class="gameSubtitle">Cultiva, comercia y construye tu imperio agr√≠cola</p>
      
      <div class="mainMenu">
        <button class="menuBtn primary" id="btnPlay">üéÆ Jugar Solo</button>
        <button class="menuBtn secondary" id="btnOnline">üåê Modo Online</button>
        <button class="menuBtn" id="btnSettings">‚öôÔ∏è Configuraciones</button>
        <button class="menuBtn" id="btnCredits">üìú Cr√©ditos</button>
      </div>
    </div>
  </div>

  <!-- ===== PANEL DE CONFIGURACIONES ===== -->
  <div class="settingsPanel slideIn" id="settingsPanel">
    <div class="settingsHeader">
      <h3>‚öôÔ∏è Configuraciones</h3>
      <button class="closeBtn" id="closeSettings">‚úï</button>
    </div>
    
    <div class="settingGroup">
      <label class="settingLabel">üë§ Nombre del Jugador</label>
      <input type="text" class="settingControl" id="playerName" placeholder="Ingresa tu nombre" value="Granjero">
    </div>
    
    <div class="settingGroup">
      <label class="settingLabel">üè∑Ô∏è Nombre de la Granja</label>
      <input type="text" class="settingControl" id="farmNameInput" placeholder="Nombre de tu granja" value="Mi Granja">
    </div>
    
    <div class="settingGroup">
      <label class="settingLabel">üîä Volumen de Efectos: <span id="sfxValue">80</span>%</label>
      <input type="range" class="settingControl slider" id="sfxVolume" min="0" max="100" value="80">
    </div>
    
    <div class="settingGroup">
      <label class="settingLabel">üéµ Volumen de M√∫sica: <span id="musicValue">60</span>%</label>
      <input type="range" class="settingControl slider" id="musicVolume" min="0" max="100" value="60">
    </div>
    
    <div class="settingGroup">
      <label class="settingLabel">üí∞ Dinero Inicial</label>
      <select class="settingControl" id="startingMoney">
        <option value="50">Principiante - $50</option>
        <option value="100">Intermedio - $100</option>
        <option value="200">Avanzado - $200</option>
        <option value="500">Experto - $500</option>
      </select>
    </div>
    
    <div class="settingGroup">
      <label class="settingLabel">
        <input type="checkbox" class="checkbox" id="autoSave" checked>
        üíæ Guardado Autom√°tico
      </label>
    </div>
    
    <div class="settingGroup">
      <label class="settingLabel">
        <input type="checkbox" class="checkbox" id="showTutorial" checked>
        üìñ Mostrar Tutorial
      </label>
    </div>
    
    <div class="settingGroup">
      <label class="settingLabel">üé® Tema Visual</label>
      <select class="settingControl" id="visualTheme">
        <option value="default">Cl√°sico</option>
        <option value="dark">Oscuro</option>
        <option value="colorful">Colorido</option>
        <option value="minimal">Minimalista</option>
      </select>
    </div>
    
    <button class="menuBtn primary" id="saveSettings" style="width:100%;margin-top:1rem">üíæ Guardar Configuraci√≥n</button>
  </div>

  <!-- ===== PANEL ONLINE ===== -->
  <div class="onlinePanel slideIn" id="onlinePanel">
    <div class="settingsHeader">
      <h3>üåê Modo Online</h3>
      <button class="closeBtn" id="closeOnline">‚úï</button>
    </div>
    
    <div class="onlineOptions">
      <div class="onlineCard" id="createRoom">
        <h4>üèóÔ∏è Crear Sala</h4>
        <p>Crea una nueva sala de juego y invita a tus amigos a cultivar juntos. T√∫ ser√°s el host y podr√°s configurar las reglas.</p>
      </div>
      
      <div class="onlineCard" id="joinRoom">
        <h4>üö™ Unirse a Sala</h4>
        <p>√önete a una sala existente usando un c√≥digo de invitaci√≥n. Colabora con otros jugadores en una gran granja comunitaria.</p>
        <div class="roomInput">
          <input type="text" placeholder="C√≥digo de sala" id="roomCode" maxlength="6">
          <button class="menuBtn" id="joinRoomBtn">Unirse</button>
        </div>
      </div>
      
      <div class="onlineCard" id="quickMatch">
        <h4>‚ö° Partida R√°pida</h4>
        <p>Encuentra autom√°ticamente una sala disponible y comienza a jugar inmediatamente con otros agricultores en l√≠nea.</p>
      </div>
      
      <div class="onlineCard" id="leaderboard">
        <h4>üèÜ Clasificaci√≥n</h4>
        <p>Mira las mejores granjas del mundo, compite por ser el mejor agricultor y gana recompensas exclusivas.</p>
      </div>
    </div>
    
    <button class="backBtn" id="backFromOnline">‚Üê Volver</button>
  </div>

  <!-- ===== JUEGO (Oculto inicialmente) ===== -->
  <div class="gameScreen" id="gameScreen">
    <div class="hud">
      <div class="chip">üí∞ <span class="val" id="money">50</span></div>
      <div style="margin-left:auto" class="chip" id="farmTag">üè∑Ô∏è <span id="farmName">Mi Granja</span></div>
    </div>

    <!-- Panel de Inventario -->
    <div class="inventoryPanel">
      <div class="inventoryTitle">üì¶ Inventario</div>
      <div class="inventoryGrid" id="inventoryGrid">
        <!-- Se genera din√°micamente -->
      </div>
    </div>

    <div class="dock">
      <div class="dockInner">
        <button class="btn" id="btnJump">Saltar</button>
        <button class="btn" id="btnInteract">Interactuar</button>
        <button class="btn" id="btnMenu">Men√∫</button>
      </div>
    </div>

    <div class="joystick" id="joystick"><div class="joyBase"></div><div class="joyKnob" id="knob"></div></div>
    <div class="lookPad" id="lookPad"></div>

    <!-- Tienda -->
    <div class="storePanel" id="storePanel">
      <div class="storeHeader">
        <h3>üè™ Garden Mart - Semillas Premium</h3>
        <button class="btn" id="closeStore">Cerrar</button>
      </div>
      <div class="seedGrid" id="seedGrid"></div>
      <div style="display:flex;gap:12px;justify-content:center">
        <button class="btn" id="viewCart">Ver Carrito (<span id="cartCount">0</span>)</button>
        <button class="btn" id="checkout">Pagar</button>
      </div>
    </div>

    <!-- Carrito -->
    <div class="cartPanel" id="cartPanel">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
        <h4>üõí Carrito</h4>
        <button class="btn" id="closeCart">‚úï</button>
      </div>
      <div id="cartItems"></div>
      <div class="cartTotal">
        Total: $<span id="cartTotalAmount">0</span>
      </div>
      <button class="btn" id="proceedCheckout" style="width:100%;margin-top:12px">Proceder al Pago</button>
    </div>

    <!-- Caja de Entrega -->
    <div class="deliveryBox" id="deliveryBox">
      <div>üì¶ ¬°Tu Pedido Ha Llegado!</div>
      <div class="ticketInfo">
        <div>üßæ Ticket #<span id="orderNumber">001</span></div>
        <div>üìã <span id="orderItems">Items del pedido</span></div>
      </div>
      <div>üëÜ Toca para abrir la caja</div>
    </div>

    <!-- Di√°logo del NPC -->
    <div class="npcDialog" id="npcDialog">
      <div class="npcName">Roberto - Vendedor</div>
      <div id="npcMessage">¬°Bienvenido a Garden Mart! ¬øEn qu√© puedo ayudarte?</div>
    </div>

    <div class="toast" id="toast"></div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/three@0.156.0/build/three.min.js"></script>

  <script>
  // ----- CONFIGURACI√ìN GLOBAL -----
  let gameConfig = {
    playerName: 'Granjero',
    farmName: 'Mi Granja',
    sfxVolume: 80,
    musicVolume: 60,
    startingMoney: 50,
    autoSave: true,
    showTutorial: true,
    visualTheme: 'default'
  };

  // ----- ESTADO DEL JUEGO -----
  let state = { 
    money: 50, 
    farmName: 'Mi Granja', 
    plants: [],
    cart: [],
    inventory: {
      carrot: 3,
      tomato: 2,
      corn: 0,
      lettuce: 1,
      potato: 0,
      pepper: 0
    },
    orderCounter: 1,
    npcState: 'idle', // idle, walking, delivering
    gameStarted: false
  };

  // Cat√°logo de semillas expandido
  const seedCatalog = [
    {id: 'carrot', name: 'Zanahoria', price: 2, desc: 'Crece r√°pido, perfecta para principiantes', icon: 'ü•ï', color: '#FF6B35', growTime: 8000},
    {id: 'tomato', name: 'Tomate', price: 4, desc: 'Jugoso y nutritivo, gran demanda', icon: 'üçÖ', color: '#FF4444', growTime: 12000},
    {id: 'corn', name: 'Ma√≠z', price: 6, desc: 'Alto rendimiento, cultivo premium', icon: 'üåΩ', color: '#FFD700', growTime: 15000},
    {id: 'lettuce', name: 'Lechuga', price: 3, desc: 'Fresca y crujiente, f√°cil cuidado', icon: 'ü•¨', color: '#4CAF50', growTime: 10000},
    {id: 'potato', name: 'Papa', price: 5, desc: 'Vers√°til y rentable, larga duraci√≥n', icon: 'ü•î', color: '#8D6E63', growTime: 14000},
    {id: 'pepper', name: 'Pimiento', price: 7, desc: 'Picante y colorido, alta ganancia', icon: 'üå∂Ô∏è', color: '#F44336', growTime: 16000}
  ];

  // ----- MANEJO DE PANTALLAS -----
  const startScreen = document.getElementById('startScreen');
  const gameScreen = document.getElementById('gameScreen');
  const settingsPanel = document.getElementById('settingsPanel');
  const onlinePanel = document.getElementById('onlinePanel');

  // Cargar configuraci√≥n guardada
  function loadSettings() {
    const saved = localStorage.getItem('gardenSimulatorConfig');
    if (saved) {
      gameConfig = {...gameConfig, ...JSON.parse(saved)};
      applySettings();
    }
  }

  // Aplicar configuraci√≥n a la UI
  function applySettings() {
    document.getElementById('playerName').value = gameConfig.playerName;
    document.getElementById('farmNameInput').value = gameConfig.farmName;
    document.getElementById('sfxVolume').value = gameConfig.sfxVolume;
    document.getElementById('musicVolume').value = gameConfig.musicVolume;
    document.getElementById('startingMoney').value = gameConfig.startingMoney;
    document.getElementById('autoSave').checked = gameConfig.autoSave;
    document.getElementById('showTutorial').checked = gameConfig.showTutorial;
    document.getElementById('visualTheme').value = gameConfig.visualTheme;
    
    document.getElementById('sfxValue').textContent = gameConfig.sfxVolume;
    document.getElementById('musicValue').textContent = gameConfig.musicVolume;
    
    // Aplicar configuraci√≥n al juego
    state.money = gameConfig.startingMoney;
    state.farmName = gameConfig.farmName;
  }

  // Guardar configuraci√≥n
  function saveSettings() {
    gameConfig.playerName = document.getElementById('playerName').value;
    gameConfig.farmName = document.getElementById('farmNameInput').value;
    gameConfig.sfxVolume = document.getElementById('sfxVolume').value;
    gameConfig.musicVolume = document.getElementById('musicVolume').value;
    gameConfig.startingMoney = parseInt(document.getElementById('startingMoney').value);
    gameConfig.autoSave = document.getElementById('autoSave').checked;
    gameConfig.showTutorial = document.getElementById('showTutorial').checked;
    gameConfig.visualTheme = document.getElementById('visualTheme').value;
    
    localStorage.setItem('gardenSimulatorConfig', JSON.stringify(gameConfig));
    
    // Aplicar cambios inmediatos
    state.money = gameConfig.startingMoney;
    state.farmName = gameConfig.farmName;
    updateUI();
    
    showToast('¬°Configuraci√≥n guardada! ‚úÖ');
  }

  // Iniciar el juego
  function startGame() {
    startScreen.style.display = 'none';
    gameScreen.classList.add('active');
    state.gameStarted = true;
    
    // Inicializar el juego 3D
    initializeGame();
    
    if (gameConfig.showTutorial) {
      setTimeout(() => {
        showToast('¬°Bienvenido! Usa el joystick para moverte y toca los elementos para interactuar üéÆ');
      }, 1000);
    }
  }

  // ----- EVENT LISTENERS PARA MEN√öS -----
  document.getElementById('btnPlay').addEventListener('click', startGame);

  document.getElementById('btnSettings').addEventListener('click', () => {
    settingsPanel.style.display = 'block';
  });

  document.getElementById('btnOnline').addEventListener('click', () => {
    onlinePanel.style.display = 'block';
  });

  document.getElementById('btnCredits').addEventListener('click', () => {
    showToast('Garden Simulator v1.0 - Desarrollado con ‚ù§Ô∏è y Three.js');
  });

  document.getElementById('closeSettings').addEventListener('click', () => {
    settingsPanel.style.display = 'none';
  });

  document.getElementById('closeOnline').addEventListener('click', () => {
    onlinePanel.style.display = 'none';
  });

  document.getElementById('backFromOnline').addEventListener('click', () => {
    onlinePanel.style.display = 'none';
  });

  document.getElementById('saveSettings').addEventListener('click', saveSettings);

  // Sliders de volumen
  document.getElementById('sfxVolume').addEventListener('input', (e) => {
    document.getElementById('sfxValue').textContent = e.target.value;
  });

  document.getElementById('musicVolume').addEventListener('input', (e) => {
    document.getElementById('musicValue').textContent = e.target.value;
  });

  // Opciones online
  document.getElementById('createRoom').addEventListener('click', () => {
    showToast('üèóÔ∏è Funci√≥n de crear sala pr√≥ximamente...');
  });

  document.getElementById('joinRoomBtn').addEventListener('click', () => {
    const code = document.getElementById('roomCode').value;
    if (code.length === 6) {
      showToast(`üö™ Intentando unirse a sala: ${code}...`);
    } else {
      showToast('‚ùå Ingresa un c√≥digo v√°lido de 6 caracteres');
    }
  });

  document.getElementById('quickMatch').addEventListener('click', () => {
    showToast('‚ö° Buscando partida r√°pida...');
  });

  document.getElementById('leaderboard').addEventListener('click', () => {
    showToast('üèÜ Tabla de clasificaci√≥n pr√≥ximamente...');
  });

  // Bot√≥n de men√∫ en el juego
  document.getElementById('btnMenu').addEventListener('click', () => {
    if (confirm('¬øRegresar al men√∫ principal? (El progreso se guardar√°)')) {
      if (gameConfig.autoSave) {
        // Aqu√≠ se guardar√≠a el progreso
        localStorage.setItem('gardenSimulatorSave', JSON.stringify(state));
      }
      
      startScreen.style.display = 'flex';
      gameScreen.classList.remove('active');
      state.gameStarted = false;
    }
  });

  // ----- THREE.JS SETUP -----
  let scene, camera, renderer;
  let plots = [], cropsGroup, plotGroup, storeGroup, npcGroup;
  let yaw = 0, pitch = 0;
  let joy = {x: 0, y: 0, active: false};
  let vel = new THREE.Vector3();
  let canJump = true;
  let currentDelivery = null;

  function initializeGame() {
    if (state.gameStarted && scene) return; // Ya inicializado

    // ----- THREE.JS SETUP -----
    scene = new THREE.Scene();
    scene.background = new THREE.Color(0x9ed7ff);
    
    camera = new THREE.PerspectiveCamera(70, innerWidth/innerHeight, 0.1, 600);
    camera.position.set(0, 1.7, 15);
    
    renderer = new THREE.WebGLRenderer({antialias: true});
    renderer.setPixelRatio(Math.min(devicePixelRatio, 2));
    renderer.setSize(innerWidth, innerHeight);
    renderer.shadowMap.enabled = true;
    renderer.shadowMap.type = THREE.PCFSoftShadowMap;
    
    // Limpiar canvas previo si existe
    const existingCanvas = document.querySelector('canvas');
    if (existingCanvas) {
      existingCanvas.remove();
    }
    
    gameScreen.appendChild(renderer.domElement);

    // Iluminaci√≥n mejorada
    const lightHemi = new THREE.HemisphereLight(0xffffff, 0x4444ff, 0.8);
    scene.add(lightHemi);
    
    const dirLight = new THREE.DirectionalLight(0xffffff, 0.8);
    dirLight.position.set(10, 15, 5);
    dirLight.castShadow = true;
    dirLight.shadow.mapSize.width = 2048;
    dirLight.shadow.mapSize.height = 2048;
    scene.add(dirLight);

    // Suelo
    const ground = new THREE.Mesh(
      new THREE.BoxGeometry(200, 0.4, 200), 
      new THREE.MeshStandardMaterial({color: 0x6fbf5f})
    );
    ground.position.y = -0.2;
    ground.receiveShadow = true;
    scene.add(ground);

    // ----- PLOTS -----
    plots = [];
    plotGroup = new THREE.Group();
    scene.add(plotGroup);
    
    const plotSize = 2.2;
    const gap = 0.8;
    for(let rz = 0; rz < 3; rz++) {
      for(let cx = 0; cx < 4; cx++) {
        const x = -6 + cx * (plotSize + gap);
        const z = -2 + rz * (plotSize + gap);
        plots.push({x, z});
        
        // Suelo del plot
        const soil = new THREE.Mesh(
          new THREE.BoxGeometry(plotSize, 0.14, plotSize), 
          new THREE.MeshStandardMaterial({color: 0x5a3d2b})
        );
        soil.position.set(x, 0.02, z);
        soil.receiveShadow = true;
        soil.userData = {type: 'plot', plotIndex: plots.length - 1};
        plotGroup.add(soil);
        
        // Marco de madera
        const frameMat = new THREE.MeshStandardMaterial({color: 0x8b5a2b});
        const thickness = 0.16;
        
        const borders = [
          {pos: [x, 0.2, z - plotSize/2 - thickness/2], size: [plotSize + thickness, 0.3, thickness]},
          {pos: [x, 0.2, z + plotSize/2 + thickness/2], size: [plotSize + thickness, 0.3, thickness]},
          {pos: [x - plotSize/2 - thickness/2, 0.2, z], size: [thickness, 0.3, plotSize + thickness]},
          {pos: [x + plotSize/2 + thickness/2, 0.2, z], size: [thickness, 0.3, plotSize + thickness]}
        ];
        
        borders.forEach(border => {
          const frame = new THREE.Mesh(new THREE.BoxGeometry(...border.size), frameMat);
          frame.position.set(...border.pos);
          frame.castShadow = true;
          plotGroup.add(frame);
        });
      }
    }

    // ----- TIENDA REALISTA -----
    storeGroup = new THREE.Group();
    
    // Edificio principal
    const storeBase = new THREE.Mesh(
      new THREE.BoxGeometry(12, 4, 8), 
      new THREE.MeshStandardMaterial({color: 0xe3f2fd})
    );
    storeBase.position.set(0, 2, -15);
    storeBase.castShadow = true;
    storeBase.userData = {type: 'store'};
    storeGroup.add(storeBase);

    // Techo
    const roof = new THREE.Mesh(
      new THREE.BoxGeometry(13, 0.3, 9), 
      new THREE.MeshStandardMaterial({color: 0x1976d2})
    );
    roof.position.set(0, 4.2, -15);
    storeGroup.add(roof);

    // Letrero
    const sign = new THREE.Mesh(
      new THREE.BoxGeometry(8, 1, 0.2), 
      new THREE.MeshStandardMaterial({color: 0x4CAF50})
    );
    sign.position.set(0, 3.5, -10.9);
    storeGroup.add(sign);

    // Puerta de cristal
    const door = new THREE.Mesh(
      new THREE.BoxGeometry(2, 3, 0.1), 
      new THREE.MeshStandardMaterial({
        color: 0x81c784, 
        transparent: true, 
        opacity: 0.7
      })
    );
    door.position.set(0, 1.5, -10.95);
    door.userData = {type: 'store'};
    storeGroup.add(door);

    // NPC Vendedor
    npcGroup = new THREE.Group();
    
    // Cuerpo del NPC
    const npcBody = new THREE.Mesh(
      new THREE.BoxGeometry(0.6, 1.2, 0.4), 
      new THREE.MeshStandardMaterial({color: 0x2196F3})
    );
    npcBody.position.y = 1.2;
    npcGroup.add(npcBody);
    
    // Cabeza
    const npcHead = new THREE.Mesh(
      new THREE.BoxGeometry(0.4, 0.4, 0.4), 
      new THREE.MeshStandardMaterial({color: 0xffdbcb})
    );
    npcHead.position.y = 2.0;
    npcGroup.add(npcHead);
    
    // Brazos
    const armLeft = new THREE.Mesh(
      new THREE.BoxGeometry(0.2, 0.8, 0.2), 
      new THREE.MeshStandardMaterial({color: 0xffdbcb})
    );
    armLeft.position.set(-0.5, 1.2, 0);
    npcGroup.add(armLeft);
    
    const armRight = armLeft.clone();
    armRight.position.set(0.5, 1.2, 0);
    npcGroup.add(armRight);
    
    npcGroup.position.set(1.5, 0, -14);
    npcGroup.userData = {type: 'npc'};
    storeGroup.add(npcGroup);
    
    scene.add(storeGroup);

    // ----- PLANTAS -----
    cropsGroup = new THREE.Group();
    scene.add(cropsGroup);

    // Configurar controles
    setupControls();
    
    // Inicializar UI del juego
    updateUI();
    updateInventory();
    updateCartDisplay();
    rebuildPlants();
    
    // Iniciar game loop
    gameLoop();
  }

  // [RESTO DEL C√ìDIGO DEL JUEGO - CONTROLES, L√ìGICA, ETC.]
  function setupControls() {
    camera.rotation.order = 'YXZ';
    
    function applyCam() {
      camera.rotation.set(pitch, yaw, 0, 'YXZ');
    }

    // Joystick
    const joyEl = document.getElementById('joystick');
    const knob = document.getElementById('knob');
    
    joyEl.addEventListener('touchstart', (e) => {
      joy.active = true;
      e.preventDefault();
    }, {passive: false});
    
    joyEl.addEventListener('touchmove', (e) => {
      e.preventDefault();
      const touch = e.touches[0];
      const rect = joyEl.getBoundingClientRect();
      const centerX = rect.left + rect.width / 2;
      const centerY = rect.top + rect.height / 2;
      
      let dx = touch.clientX - centerX;
      let dy = touch.clientY - centerY;
      
      const maxRadius = rect.width * 0.42;
      const distance = Math.hypot(dx, dy);
      const clamp = distance > maxRadius ? maxRadius / distance : 1;
      
      dx *= clamp;
      dy *= clamp;
      
      knob.style.transform = `translate(${dx}px, ${dy}px)`;
      
      joy.x = dx / maxRadius;
      joy.y = dy / maxRadius;
    }, {passive: false});
    
    joyEl.addEventListener('touchend', () => {
      joy.active = false;
      joy.x = 0;
      joy.y = 0;
      knob.style.transform = 'translate(-50%, -50%)';
    });

    // Look pad
    const lookPad = document.getElementById('lookPad');
    let lastLook = null;
    let lookVelX = 0, lookVelY = 0;
    
    lookPad.addEventListener('touchstart', e => {
      lastLook = e.touches[0];
    }, {passive: true});
    
    lookPad.addEventListener('touchmove', e => {
      const touch = e.touches[0];
      if (!lastLook) {
        lastLook = touch;
        return;
      }
      
      const dx = touch.clientX - lastLook.clientX;
      const dy = touch.clientY - lastLook.clientY;
      lastLook = touch;
      
      const sensitivity = 0.001;
      lookVelX += (-dx * sensitivity);
      lookVelY += (-dy * sensitivity);
    }, {passive: true});
    
    lookPad.addEventListener('touchend', () => {
      lastLook = null;
    });

    // Raycast para toque
    const raycaster = new THREE.Raycaster();
    const mouse = new THREE.Vector2();

    renderer.domElement.addEventListener('touchend', (e) => {
      if (e.touches.length === 0 && e.changedTouches.length === 1) {
        const touch = e.changedTouches[0];
        
        mouse.x = (touch.clientX / window.innerWidth) * 2 - 1;
        mouse.y = -(touch.clientY / window.innerHeight) * 2 + 1;
        
        raycaster.setFromCamera(mouse, camera);
        const intersects = raycaster.intersectObjects(scene.children, true);
        
        if (intersects.length > 0) {
          handleTouch(intersects[0], touch);
        }
      }
    });

    // Game loop interno
    let lastTime = performance.now();
    
    window.gameLoop = function() {
      if (!state.gameStarted) return;
      
      requestAnimationFrame(gameLoop);
      
      const currentTime = performance.now();
      const deltaTime = Math.min((currentTime - lastTime) / 1000, 0.05);
      lastTime = currentTime;
      
      // Aplicar velocidades de look con damping
      lookVelX *= 0.9;
      lookVelY *= 0.9;
      
      yaw += lookVelX;
      pitch += lookVelY;
      
      const maxPitch = Math.PI / 2 - 0.1;
      pitch = Math.max(-maxPitch, Math.min(maxPitch, pitch));
      
      applyCam();
      
      // Movimiento
      if (joy.active) {
        const speed = 8;
        
        const forward = new THREE.Vector3(
          Math.sin(yaw), 
          0, 
          Math.cos(yaw)
        ).normalize();
        
        const right = new THREE.Vector3().crossVectors(
          new THREE.Vector3(0, 1, 0), 
          forward
        ).normalize();
        
        const moveForward = -joy.y;
        const moveRight = joy.x;
        
        vel.x += (forward.x * moveForward + right.x * moveRight) * speed * deltaTime;
        vel.z += (forward.z * moveForward + right.z * moveRight) * speed * deltaTime;
      }
      
      // Fricci√≥n y gravedad
      vel.x *= 0.9;
      vel.z *= 0.9;
      vel.y -= 25 * deltaTime;
      
      // Aplicar velocidad
      camera.position.x += vel.x * deltaTime;
      camera.position.y += vel.y * deltaTime;
      camera.position.z += vel.z * deltaTime;
      
      // Colisi√≥n con suelo
      if (camera.position.y < 1.7) {
        camera.position.y = 1.7;
        vel.y = 0;
        canJump = true;
      }
      
      // Actualizar sistema de entrega
      updateDelivery();
      
      // Animar plantas
      if (cropsGroup) {
        cropsGroup.children.forEach(plant => {
          plant.rotation.y += 0.01;
        });
      }
      
      // Animar NPC
      if (state.npcState === 'idle' && npcGroup) {
        npcGroup.rotation.y = Math.sin(currentTime * 0.001) * 0.1;
      }
      
      renderer.render(scene, camera);
    };
  }

  // [RESTO DE FUNCIONES DEL JUEGO - handleTouch, updateInventory, etc.]
  function handleTouch(intersect, touch) {
    const object = intersect.object;
    const userData = object.userData;
    
    showTouchIndicator(touch.clientX, touch.clientY);
    
    if (userData.type === 'store' || userData.type === 'npc') {
      const distance = camera.position.distanceTo(intersect.point);
      if (distance < 8) {
        openStore();
      } else {
        showToast('Ac√©rcate m√°s a la tienda üè™');
      }
    } else if (userData.type === 'plot') {
      handlePlotTouch(userData.plotIndex);
    } else if (userData.type === 'plant') {
      handlePlantTouch(userData.plotIndex);
    }
  }

  function showTouchIndicator(x, y) {
    const indicator = document.createElement('div');
    indicator.className = 'touchIndicator';
    indicator.style.left = (x - 15) + 'px';
    indicator.style.top = (y - 15) + 'px';
    document.body.appendChild(indicator);
    
    setTimeout(() => {
      document.body.removeChild(indicator);
    }, 500);
  }

  function handlePlotTouch(plotIndex) {
    const existing = state.plants.find(p => p.plotIndex === plotIndex);
    if (existing) {
      showToast('Ya hay una planta aqu√≠ üå±');
      return;
    }
    
    const availableSeed = Object.keys(state.inventory).find(seedId => state.inventory[seedId] > 0);
    
    if (!availableSeed) {
      showToast('No tienes semillas üå±');
      return;
    }
    
    state.inventory[availableSeed]--;
    state.plants.push({
      plotIndex: plotIndex,
      plantedAt: Date.now(),
      type: availableSeed
    });
    
    rebuildPlants();
    updateInventory();
    updateUI();
    showToast(`¬°${seedCatalog.find(s => s.id === availableSeed).name} plantada! üå±`);
  }

  function handlePlantTouch(plotIndex) {
    const plantIndex = state.plants.findIndex(p => p.plotIndex === plotIndex);
    if (plantIndex === -1) return;
    
    const plantData = state.plants[plantIndex];
    const age = Date.now() - plantData.plantedAt;
    const seedInfo = seedCatalog.find(s => s.id === plantData.type);
    const growTime = seedInfo ? seedInfo.growTime : 12000;
    
    if (age >= growTime) {
      state.plants.splice(plantIndex, 1);
      state.money += 5;
      
      if (Math.random() < 0.3) {
        state.inventory[plantData.type] = (state.inventory[plantData.type] || 0) + 1;
      }
      
      rebuildPlants();
      updateInventory();
      updateUI();
      showToast(`¬°${seedInfo.name} cosechada! +$5 üí∞`);
    } else {
      const remainingTime = Math.ceil((growTime - age) / 1000);
      showToast(`La planta estar√° lista en ${remainingTime}s üå±`);
    }
  }

  function updateInventory() {
    const grid = document.getElementById('inventoryGrid');
    grid.innerHTML = '';
    
    seedCatalog.forEach(seed => {
      const count = state.inventory[seed.id] || 0;
      const slot = document.createElement('div');
      slot.className = `inventorySlot ${count > 0 ? 'has-item' : ''}`;
      slot.innerHTML = count > 0 ? 
        `<div>${seed.icon}</div><div class="slotCount">${count}</div>` : 
        `<div style="opacity:0.3">${seed.icon}</div>`;
      grid.appendChild(slot);
    });
  }

  function rebuildPlants() {
    if (!cropsGroup) return;
    
    while (cropsGroup.children.length) {
      cropsGroup.remove(cropsGroup.children[0]);
    }
    
    const now = Date.now();
    
    state.plants.forEach(plant => {
      const plot = plots[plant.plotIndex];
      if (!plot) return;
      
      const seedInfo = seedCatalog.find(s => s.id === plant.type);
      const growTime = seedInfo ? seedInfo.growTime : 12000;
      const age = now - plant.plantedAt;
      const growthStage = Math.min(age / growTime, 1);
      
      const size = 0.3 + growthStage * 0.7;
      const color = growthStage >= 1 ? 0xffd54f : seedInfo.color;
      
      const plantMesh = new THREE.Mesh(
        new THREE.BoxGeometry(0.4 * size, 0.8 * size, 0.4 * size),
        new THREE.MeshStandardMaterial({color})
      );
      
      plantMesh.position.set(plot.x, 0.2 + (0.4 * size), plot.z);
      plantMesh.castShadow = true;
      plantMesh.userData = {type: 'plant', plotIndex: plant.plotIndex, plantedAt: plant.plantedAt};
      
      cropsGroup.add(plantMesh);
    });
  }

  function updateUI() {
    document.getElementById('money').textContent = state.money;
    document.getElementById('farmName').textContent = state.farmName;
  }

  function showToast(message, duration = 2000) {
    const toast = document.getElementById('toast');
    toast.textContent = message;
    toast.style.display = 'block';
    
    setTimeout(() => {
      toast.style.display = 'none';
    }, duration);
  }

  // Funciones de tienda simplificadas
  function openStore() {
    document.getElementById('storePanel').style.display = 'block';
    showToast('¬°Bienvenido a Garden Mart! üè™');
  }

  function updateCartDisplay() {
    document.getElementById('cartCount').textContent = state.cart.reduce((sum, item) => sum + item.quantity, 0);
    document.getElementById('cartTotalAmount').textContent = state.cart.reduce((sum, item) => sum + item.price * item.quantity, 0);
  }

  function updateDelivery() {
    // Placeholder para sistema de entrega
  }

  // Event listeners adicionales del juego
  document.getElementById('btnInteract').addEventListener('click', () => {
    const playerPos = camera.position;
    const storeDistance = playerPos.distanceTo(new THREE.Vector3(0, 1.7, -12));
    
    if (storeDistance < 6) {
      openStore();
    } else {
      showToast('Ac√©rcate a algo para interactuar');
    }
  });

  document.getElementById('btnJump').addEventListener('click', () => {
    if (canJump) {
      vel.y = 8;
      canJump = false;
    }
  });

  document.getElementById('closeStore').addEventListener('click', () => {
    document.getElementById('storePanel').style.display = 'none';
  });

  // Resize handler
  window.addEventListener('resize', () => {
    if (camera && renderer) {
      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
    }
  });

  // ----- INICIALIZACI√ìN -----
  loadSettings();
  applySettings();

  </script>
</body>
</html>
